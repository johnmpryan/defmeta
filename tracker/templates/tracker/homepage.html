{% extends "tracker/base.html" %}
{% load humanize %}

{% block title %}Reddit Stats - Homepage{% endblock %}

{% block extra_css %}
<style>
    /* ===== TAB NAVIGATION ===== */
    .tab-container {
        display: flex;
        gap: 0;
        margin-bottom: 0;
        border-bottom: 2px solid #2a662a;
    }
    
    .tab-button {
        background: #1a1a1a;
        color: #888;
        border: 2px solid #2a662a;
        border-bottom: none;
        padding: 10px 30px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .tab-button:hover {
        background: #252525;
        color: #00FF00;
    }
    
    .tab-button.active {
        background: #252525;
        color: #00FF00;
        border-bottom: 2px solid #252525;
        margin-bottom: -2px;
    }
    
    .tab-content {
        display: none;
        padding: 30px;
    }
    
    .tab-content.active {
        display: block;
    }
    
    /* ===== CHART STYLING ===== */
    .chart-container {
        position: relative;
        height: 400px;
        margin: 20px 0;
    }
    
    /* ===== HOMEPAGE-SPECIFIC TABLE LAYOUT ===== */
    
    /* Desktop: prompt (25px) + name (180px) + 4 stat columns */
    .table-header {
        grid-template-columns: 25px 180px 1fr;
    }
    
    .header-stats {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .table-row {
        grid-template-columns: 25px 180px 1fr;
    }
    
    .row-stats {
        grid-template-columns: repeat(4, 1fr);
    }
    
    /* ===== RESPONSIVE: MOBILE ===== */
    
    /* Tablet/Mobile: Show only name and subscribers */
    @media (max-width: 768px) {
        .table-header {
            grid-template-columns: 25px 1fr 140px;
        }
        
        .header-stats {
            grid-template-columns: 1fr;
        }
        
        /* Hide all stats except subscribers in header */
        .header-stats .header-cell:not(.header-subscribers) {
            display: none;
        }
        
        .table-row {
            grid-template-columns: 25px 1fr 140px;
        }
        
        .row-stats {
            grid-template-columns: 1fr;
        }
        
        /* Hide all stats except subscribers in rows */
        .row-stats .stat-value:not(.stat-subscribers) {
            display: none;
        }
    }
    
    /* Very small mobile: Tighten spacing further */
    @media (max-width: 480px) {
        .table-header {
            grid-template-columns: 20px 1fr 100px;
            gap: 10px;
        }
        
        .table-row {
            grid-template-columns: 20px 1fr 100px;
            gap: 10px;
        }
        
        .row-name {
            font-size: 14px;
        }
        
        .header-name,
        .header-cell {
            font-size: 14px;
        }
        
        .tab-button {
            padding: 8px 20px;
            font-size: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
    <div class="section-header">TRACKED SUBREDDITS</div>
    
    <p class="description">This application tracks engagement across U.S. State subreddits. Nightly, two processes call the Reddit API. First, subscriber count and all posts from the previous day are recorded. Then, engagement data is collected on all posts three days old. This data is then summariized in a daily snapshot record. Click on any Subreddit below to view daily snapshots. [<a href="https://github.com/johnmpryan/defmeta">Github repo</a>]</p>

    <p class="description">Check back often. Data collection began in early October. New analysis and data points being added regularly.</>

    <!-- Tab Navigation -->
    <div class="terminal-table-container" style="margin-top: 30px;">
        <div class="tab-container">
            <button class="tab-button active" onclick="switchTab('data')">DATA</button>
            <button class="tab-button" onclick="switchTab('charts')">CHARTS</button>
        </div>
        
        <!-- DATA Tab Content -->
        <div id="data-tab" class="tab-content active">
            <p class="description">The table below shows most recent subscriber and post counts, as well as the count of daily 'snapshots'. Snapshots can be viewed by clicking on subreddit name.</p>
            
            {% if subreddit_data %}
                <div class="terminal-table">
                    <!-- Header Row -->
                    <div class="table-header">
                        <div class="header-prompt"></div>
                        <a href="?sort_by=name&order={% if current_sort == 'name' and current_order == 'desc' %}asc{% else %}desc{% endif %}" class="header-name">
                            Subreddit
                            {% if current_sort == 'name' %}
                                <span class="sort-arrow">{% if current_order == 'desc' %}↓{% else %}↑{% endif %}</span>
                            {% endif %}
                        </a>
                        <div class="header-stats">
                            <a href="?sort_by=subscribers&order={% if current_sort == 'subscribers' and current_order == 'desc' %}asc{% else %}desc{% endif %}" class="header-cell header-subscribers">
                                Subscribers
                                {% if current_sort == 'subscribers' %}
                                    <span class="sort-arrow">{% if current_order == 'desc' %}↓{% else %}↑{% endif %}</span>
                                {% endif %}
                            </a>
                            <a href="?sort_by=per_capita&order={% if current_sort == 'per_capita' and current_order == 'desc' %}asc{% else %}desc{% endif %}" class="header-cell header-per-capita">
                                Per 10k pop.
                                {% if current_sort == 'per_capita' %}
                                    <span class="sort-arrow">{% if current_order == 'desc' %}↓{% else %}↑{% endif %}</span>
                                {% endif %}
                            </a>                            <a href="?sort_by=snapshots&order={% if current_sort == 'snapshots' and current_order == 'desc' %}asc{% else %}desc{% endif %}" class="header-cell header-snapshots">
                                Snapshots
                                {% if current_sort == 'snapshots' %}
                                    <span class="sort-arrow">{% if current_order == 'desc' %}↓{% else %}↑{% endif %}</span>
                                {% endif %}
                            </a>


                        </div>
                    </div>
                    
                    <!-- Data Rows -->
                    {% for item in subreddit_data %}
                        <div class="table-row">
                            <span class="row-prompt">$</span>
                            <a href="/r/{{ item.subreddit.name }}/" class="row-name">r/{{ item.subreddit.name }}</a>
                            <div class="row-stats">
                                <div class="stat-value stat-subscribers">
                                    {% if item.latest_snapshot %}
                                        {{ item.latest_snapshot.subscribers_count|default_if_none:"N/A"|intcomma }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </div>
                                <div class="stat-value stat-per-capita">
                                    {{ item.per_capita|default_if_none:"N/A"|floatformat:0 }}
                                </div>                                <div class="stat-value stat-snapshots">
                                    <a href="/r/{{ item.subreddit.name }}/">
                                        {{ item.snapshot_count|intcomma }}
                                    </a>
                                </div>


                            </div>
                        </div>
                    {% empty %}
                        <div class="empty-state">
                            <p>No subreddits tracked yet.</p>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                <div class="pagination">
                    {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}&sort_by={{ current_sort }}&order={{ current_order }}" class="page-btn">← Previous</a>
                    {% else %}
                        <span class="page-btn disabled">← Previous</span>
                    {% endif %}
                    
                    <span class="page-info">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                    
                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}&sort_by={{ current_sort }}&order={{ current_order }}" class="page-btn">Next →</a>
                    {% else %}
                        <span class="page-btn disabled">Next →</span>
                    {% endif %}
                </div>
                {% endif %}
            {% else %}
                <div class="empty-state">
                    <p>No subreddits tracked yet.</p>
                </div>
            {% endif %}
        </div>
        
        <!-- CHARTS Tab Content -->
        <div id="charts-tab" class="tab-content">
            <h2 style="color: #00FF00; margin-bottom: 20px;">Activity vs Subscribers by State Population</h2>
            <div class="chart-container" style="height: 600px;">
                <canvas id="bubbleChart"></canvas>
            </div>
            
            <h2 style="color: #00FF00; margin: 40px 0 20px;">Total Subscribers Across All State Subreddits</h2>
            <div class="chart-container">
                <canvas id="totalSubscribersChart"></canvas>
            </div>
        </div>
    </div>

<script>
function switchTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active state from all buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Activate clicked button
    event.target.classList.add('active');
}

// Chart.js configuration for terminal aesthetic
Chart.defaults.color = '#00FF00';
Chart.defaults.borderColor = '#2a662a';

// LINE CHART: Total Subscribers Over Time
const lineChartData = {{ line_chart_data|safe }};

const lineCtx = document.getElementById('totalSubscribersChart').getContext('2d');
const totalSubscribersChart = new Chart(lineCtx, {
    type: 'line',
    data: {
        labels: lineChartData.labels,
        datasets: [{
            label: 'Total Subscribers',
            data: lineChartData.data,
            borderColor: '#00FF00',
            backgroundColor: 'rgba(0, 255, 0, 0.1)',
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: '#00FF00',
            pointBorderColor: '#00FF00',
            pointHoverRadius: 6,
            pointHoverBackgroundColor: '#00FF00',
            pointHoverBorderColor: '#1a1a1a',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                labels: {
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace",
                        size: 12
                    }
                }
            },
            tooltip: {
                backgroundColor: '#252525',
                titleColor: '#00FF00',
                bodyColor: '#00FF00',
                borderColor: '#2a662a',
                borderWidth: 1,
                titleFont: {
                    family: "'Courier New', monospace"
                },
                bodyFont: {
                    family: "'Courier New', monospace"
                },
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        label += context.parsed.y.toLocaleString();
                        return label;
                    }
                }
            }
        },
        scales: {
            x: {
                grid: {
                    color: '#2a662a',
                    borderColor: '#2a662a'
                },
                ticks: {
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace",
                        size: 11
                    }
                }
            },
            y: {
                grid: {
                    color: '#2a662a',
                    borderColor: '#2a662a'
                },
                ticks: {
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace",
                        size: 11
                    },
                    callback: function(value) {
                        return value.toLocaleString();
                    }
                }
            }
        }
    }
});

// BUBBLE CHART: Activity vs Subscribers by State Population
const bubbleData = {{ bubble_chart_data|safe }};

const bubbleCtx = document.getElementById('bubbleChart').getContext('2d');
const bubbleChart = new Chart(bubbleCtx, {
    type: 'bubble',
    data: {
        datasets: [{
            label: 'State Subreddits',
            data: bubbleData,
            backgroundColor: 'rgba(0, 255, 0, 0.2)',
            borderColor: '#00FF00',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: '#252525',
                titleColor: '#00FF00',
                bodyColor: '#00FF00',
                borderColor: '#2a662a',
                borderWidth: 1,
                titleFont: {
                    family: "'Courier New', monospace"
                },
                bodyFont: {
                    family: "'Courier New', monospace"
                },
                callbacks: {
                    label: function(context) {
                        const point = context.raw;
                        return [
                            `r/${point.name}`,
                            `Subscribers: ${point.y.toLocaleString()}`,
                            `Posts (7d): ${point.x}`,
                            `Population: ${(point.r * 100000).toLocaleString()}`
                        ];
                    }
                }
            }
        },
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Posts in Last 7 Days',
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace",
                        size: 14
                    }
                },
                grid: {
                    color: '#2a662a',
                    borderColor: '#2a662a'
                },
                ticks: {
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace"
                    }
                }
            },
            y: {
                title: {
                    display: true,
                    text: 'Subscribers',
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace",
                        size: 14
                    }
                },
                grid: {
                    color: '#2a662a',
                    borderColor: '#2a662a'
                },
                ticks: {
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace"
                    },
                    callback: function(value) {
                        return value.toLocaleString();
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}