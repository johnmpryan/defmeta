{% extends "tracker/base.html" %}
{% load humanize %}

{% block title %}Reddit Stats - Homepage{% endblock %}

{% block extra_css %}
<style>
    /* ===== TAB NAVIGATION ===== */
    .tab-container {
        display: flex;
        gap: 0;
        margin-bottom: 0;
        border-bottom: 2px solid #2a662a;
    }
    
    .tab-button {
        background: #1a1a1a;
        color: #888;
        border: 2px solid #2a662a;
        border-bottom: none;
        padding: 10px 30px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .tab-button:hover {
        background: #252525;
        color: #00FF00;
    }
    
    .tab-button.active {
        background: #252525;
        color: #00FF00;
        border-bottom: 2px solid #252525;
        margin-bottom: -2px;
    }
    
    .tab-content {
        display: none;
        padding: 30px;
    }
    
    .tab-content.active {
        display: block;
    }
    
    /* ===== CHART STYLING ===== */
    .chart-container {
        position: relative;
        height: 400px;
        margin: 20px 0;
    }
    
    /* ===== DROPDOWN STYLING ===== */
    .subreddit-selector {
        margin: 20px 0;
    }
    
    .subreddit-selector label {
        color: #00FF00;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        margin-right: 10px;
    }
    
    .subreddit-selector select {
        background: #252525;
        color: #00FF00;
        border: 1px solid #2a662a;
        padding: 8px 15px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        cursor: pointer;
        min-width: 200px;
    }
    
    .subreddit-selector select:focus {
        outline: none;
        border-color: #00FF00;
    }
    
    /* ===== HOMEPAGE-SPECIFIC TABLE LAYOUT ===== */
    
    /* Desktop: prompt (25px) + name (180px) + 4 stat columns */
    .table-header {
        grid-template-columns: 25px 180px 1fr;
    }
    
    .header-stats {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .table-row {
        grid-template-columns: 25px 180px 1fr;
    }
    
    .row-stats {
        grid-template-columns: repeat(4, 1fr);
    }
    
    /* ===== RESPONSIVE: MOBILE ===== */
    
    /* Tablet/Mobile: Show only name and subscribers */
    @media (max-width: 768px) {
        .table-header {
            grid-template-columns: 25px 1fr 140px;
        }
        
        .header-stats {
            grid-template-columns: 1fr;
        }
        
        /* Hide all stats except subscribers in header */
        .header-stats .header-cell:not(.header-subscribers) {
            display: none;
        }
        
        .table-row {
            grid-template-columns: 25px 1fr 140px;
        }
        
        .row-stats {
            grid-template-columns: 1fr;
        }
        
        /* Hide all stats except subscribers in rows */
        .row-stats .stat-value:not(.stat-subscribers) {
            display: none;
        }
    }
    
    /* Very small mobile: Tighten spacing further */
    @media (max-width: 480px) {
        .table-header {
            grid-template-columns: 20px 1fr 100px;
            gap: 10px;
        }
        
        .table-row {
            grid-template-columns: 20px 1fr 100px;
            gap: 10px;
        }
        
        .row-name {
            font-size: 14px;
        }
        
        .header-name,
        .header-cell {
            font-size: 14px;
        }
        
        .tab-button {
            padding: 8px 20px;
            font-size: 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
    <div class="section-header">TRACKED SUBREDDITS</div>

    <p class="description">This application tracks engagement across U.S. state subreddits, demonstrating automated data collection, aggregation, and AI-powered content analysis.</p>

    <p class="description"><strong>Nightly automated pipeline:</strong><br>
    <strong>• Data collection:</strong> Reddit API retrieves subscriber counts and all posts from the previous day<br>
    <strong>• AI tagging:</strong> Claude analyzes post content and assigns categorical tags (topic, content type, sentiment)<br>
    <strong>• Engagement tracking:</strong> Posts 3+ days old are updated with scores, comments, and vote estimates<br>
    <strong>• Aggregation:</strong> Post-level metrics are rolled up into daily subreddit snapshots</p>

    <p class="description"><strong>Explore the data:</strong> Click any subreddit to view historical snapshots. Click a snapshot date to see individual posts with AI-generated tags. [<a href="https://github.com/johnmpryan/defmeta">Github repo</a>]</p>

    <p class="description">Check back often. Data collection began in early October. New analysis and data points being added regularly.</p>

    <!-- Tab Navigation -->
    <div class="terminal-table-container" style="margin-top: 30px;">
        <div class="tab-container">
            <button class="tab-button active" onclick="switchTab(event, 'data')">DATA</button>
            <button class="tab-button" onclick="switchTab(event, 'pop_effects')">POPULATION EFFECTS</button>
            <button class="tab-button" onclick="switchTab(event, 'content')">CONTENT ANALYSIS</button>
        </div>
        
        <!-- DATA Tab Content -->
        <div id="data-tab" class="tab-content active">
            <p class="description">The table below shows most recent subscriber and post counts, as well as the count of daily 'snapshots'. Snapshots can be viewed by clicking on subreddit name.</p>
            
            {% if subreddit_data %}
                <div class="terminal-table">
                    <!-- Header Row -->
                    <div class="table-header">
                        <div class="header-prompt"></div>
                        <a href="?sort_by=name&order={% if current_sort == 'name' and current_order == 'desc' %}asc{% else %}desc{% endif %}" class="header-name">
                            Subreddit
                            {% if current_sort == 'name' %}
                                <span class="sort-arrow">{% if current_order == 'desc' %}↓{% else %}↑{% endif %}</span>
                            {% endif %}
                        </a>
                        <div class="header-stats">
                            <a href="?sort_by=subscribers&order={% if current_sort == 'subscribers' and current_order == 'desc' %}asc{% else %}desc{% endif %}" class="header-cell header-subscribers">
                                Subscribers
                                {% if current_sort == 'subscribers' %}
                                    <span class="sort-arrow">{% if current_order == 'desc' %}↓{% else %}↑{% endif %}</span>
                                {% endif %}
                            </a>
                            <a href="?sort_by=per_capita&order={% if current_sort == 'per_capita' and current_order == 'desc' %}asc{% else %}desc{% endif %}" class="header-cell header-per-capita">
                                Per 10k pop.
                                {% if current_sort == 'per_capita' %}
                                    <span class="sort-arrow">{% if current_order == 'desc' %}↓{% else %}↑{% endif %}</span>
                                {% endif %}
                            </a>                            <a href="?sort_by=snapshots&order={% if current_sort == 'snapshots' and current_order == 'desc' %}asc{% else %}desc{% endif %}" class="header-cell header-snapshots">
                                Snapshots
                                {% if current_sort == 'snapshots' %}
                                    <span class="sort-arrow">{% if current_sort == 'snapshots' %}↓{% else %}↑{% endif %}</span>
                                {% endif %}
                            </a>


                        </div>
                    </div>
                    
                    <!-- Data Rows -->
                    {% for item in subreddit_data %}
                        <div class="table-row">
                            <span class="row-prompt">$</span>
                            <a href="/r/{{ item.subreddit.name }}/" class="row-name">r/{{ item.subreddit.name }}</a>
                            <div class="row-stats">
                                <div class="stat-value stat-subscribers">
                                    {% if item.latest_snapshot %}
                                        {{ item.latest_snapshot.subscribers_count|default_if_none:"N/A"|intcomma }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </div>
                                <div class="stat-value stat-per-capita">
                                    {{ item.per_capita|default_if_none:"N/A"|floatformat:0 }}
                                </div>                                <div class="stat-value stat-snapshots">
                                    <a href="/r/{{ item.subreddit.name }}/">
                                        {{ item.snapshot_count|intcomma }}
                                    </a>
                                </div>


                            </div>
                        </div>
                    {% empty %}
                        <div class="empty-state">
                            <p>No subreddits tracked yet.</p>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                <div class="pagination">
                    {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}&sort_by={{ current_sort }}&order={{ current_order }}" class="page-btn">← Previous</a>
                    {% else %}
                        <span class="page-btn disabled">← Previous</span>
                    {% endif %}
                    
                    <span class="page-info">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                    
                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}&sort_by={{ current_sort }}&order={{ current_order }}" class="page-btn">Next →</a>
                    {% else %}
                        <span class="page-btn disabled">Next →</span>
                    {% endif %}
                </div>
                {% endif %}
            {% else %}
                <div class="empty-state">
                    <p>No subreddits tracked yet.</p>
                </div>
            {% endif %}
        </div>
        
        <!-- CHARTS Tab Content -->
        <div id="pop_effects-tab" class="tab-content">
            <p class="description">Below shows the interaction between a State's population and its subreddit's subscriber and recent post counts. <strong>While a greater state population seems to lead to greater subscriber counts, it does not seem to insure greater post engagement.</strong>[future research: pop affect on like and comment engagement, New Jersey]</p>
            <h2 style="color: #00FF00; margin-bottom: 20px;">Recent Post Activity vs Subscribers by State Population</h2>
            <div class="chart-container" style="height: 600px;">
                <canvas id="bubbleChart"></canvas>
            </div>
            <p class="description">But by factoring in crude population density, a slightly more clear pattern emerges. States with greater population density seem to have more post engagement. But this signal is still mixed, with low density states still reaching the upper measures of post engagement. [future research: affects between state and city subreddits, New Jersey, other measures of density: metro areas over XXXX,]</p>

            <h2 style="color: #00FF00; margin: 40px 0 20px;">Recent Post Activity vs Subscribers by Population Density</h2>
            <p class="description">District of Columbia excluded, pop density 10x greater than next closest. <p>
            <div class="chart-container" style="height: 600px;">
                <canvas id="densityBubbleChart"></canvas>
            </div>
            
            <h2 style="color: #00FF00; margin: 40px 0 20px;">Total Subscribers Across All State Subreddits</h2>
            <div class="chart-container">
                <canvas id="totalSubscribersChart"></canvas>
            </div>
        </div>
        <!-- CONTENT ANALYSIS Tab Content -->
        <div id="content-tab" class="tab-content">
            <h2 style="color: #00FF00; margin-bottom: 20px;">Top Topics - Last 7 Days</h2>
            
            <!-- Subreddit Dropdown (shared by both charts) -->
            <div class="subreddit-selector">
                <label for="subredditSelect">Compare subreddit:</label>
                <select id="subredditSelect" onchange="updateAllTagCharts()">
                    <option value="all">All Subreddits</option>
                </select>
            </div>
            
            <p class="description">Select a subreddit to see how its tag usage compares to all other state subreddits. The charts show the top 20 tags globally from the last 7 days.</p>
            
            <!-- Percentage Chart -->
            <h3 style="color: #00FF00; margin: 30px 0 10px;">Tag Prevalence (% of Posts)</h3>
            <p class="description" style="margin-bottom: 20px;">Shows what percentage of posts are tagged with each topic.</p>
            <div class="chart-container" style="height: 600px;">
                <canvas id="tagPercentChart"></canvas>
            </div>
            
            <!-- Count Chart -->
            <h3 style="color: #00FF00; margin: 40px 0 10px;">Tag Usage (Post Count)</h3>
            <p class="description" style="margin-bottom: 20px;">Shows the raw number of posts tagged with each topic.</p>
            <div class="chart-container" style="height: 600px;">
                <canvas id="tagChart"></canvas>
            </div>
        </div>
    </div>

<script>
function switchTab(event, tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active state from all buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Activate clicked button
    event.target.classList.add('active');
}

// Chart.js configuration for terminal aesthetic
Chart.defaults.color = '#00FF00';
Chart.defaults.borderColor = '#2a662a';

// LINE CHART: Total Subscribers Over Time
const lineChartData = {{ line_chart_data|safe }};

const lineCtx = document.getElementById('totalSubscribersChart').getContext('2d');
const totalSubscribersChart = new Chart(lineCtx, {
    type: 'line',
    data: {
        labels: lineChartData.labels,
        datasets: [{
            label: 'Total Subscribers',
            data: lineChartData.data,
            borderColor: '#00FF00',
            backgroundColor: 'rgba(0, 255, 0, 0.1)',
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: '#00FF00',
            pointBorderColor: '#00FF00',
            pointHoverRadius: 6,
            pointHoverBackgroundColor: '#00FF00',
            pointHoverBorderColor: '#1a1a1a',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                labels: {
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace",
                        size: 12
                    }
                }
            },
            tooltip: {
                backgroundColor: '#252525',
                titleColor: '#00FF00',
                bodyColor: '#00FF00',
                borderColor: '#2a662a',
                borderWidth: 1,
                titleFont: {
                    family: "'Courier New', monospace"
                },
                bodyFont: {
                    family: "'Courier New', monospace"
                },
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        label += context.parsed.y.toLocaleString();
                        return label;
                    }
                }
            }
        },
        scales: {
            x: {
                grid: {
                    color: '#2a662a',
                    borderColor: '#2a662a'
                },
                ticks: {
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace",
                        size: 11
                    }
                }
            },
            y: {
                grid: {
                    color: '#2a662a',
                    borderColor: '#2a662a'
                },
                ticks: {
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace",
                        size: 11
                    },
                    callback: function(value) {
                        return value.toLocaleString();
                    }
                }
            }
        }
    }
});

// BUBBLE CHART 1: Activity vs Subscribers by State Population
const bubbleData = {{ bubble_chart_data|safe }};

const bubbleCtx = document.getElementById('bubbleChart').getContext('2d');
const bubbleChart = new Chart(bubbleCtx, {
    type: 'bubble',
    data: {
        datasets: [{
            label: 'State Subreddits',
            data: bubbleData,
            backgroundColor: 'rgba(0, 255, 0, 0.2)',
            borderColor: '#00FF00',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: '#252525',
                titleColor: '#00FF00',
                bodyColor: '#00FF00',
                borderColor: '#2a662a',
                borderWidth: 1,
                titleFont: {
                    family: "'Courier New', monospace"
                },
                bodyFont: {
                    family: "'Courier New', monospace"
                },
                callbacks: {
                    label: function(context) {
                        const point = context.raw;
                        return [
                            `r/${point.name}`,
                            `Subscribers: ${point.y.toLocaleString()}`,
                            `Posts (7d): ${point.x}`,
                            `Population: ${point.population.toLocaleString()}`
                        ];
                    }
                }
            }
        },
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Posts in Last 7 Days',
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace",
                        size: 14
                    }
                },
                grid: {
                    color: '#2a662a',
                    borderColor: '#2a662a'
                },
                ticks: {
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace"
                    }
                }
            },
            y: {
                title: {
                    display: true,
                    text: 'Subscribers',
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace",
                        size: 14
                    }
                },
                grid: {
                    color: '#2a662a',
                    borderColor: '#2a662a'
                },
                ticks: {
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace"
                    },
                    callback: function(value) {
                        return value.toLocaleString();
                    }
                }
            }
        }
    }
});

// BUBBLE CHART 2: Activity vs Subscribers by Population Density
const densityBubbleData = {{ density_bubble_chart_data|safe }};

const densityBubbleCtx = document.getElementById('densityBubbleChart').getContext('2d');
const densityBubbleChart = new Chart(densityBubbleCtx, {
    type: 'bubble',
    data: {
        datasets: [{
            label: 'State Subreddits by Density',
            data: densityBubbleData,
            backgroundColor: 'rgba(0, 255, 0, 0.2)',
            borderColor: '#00FF00',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: '#252525',
                titleColor: '#00FF00',
                bodyColor: '#00FF00',
                borderColor: '#2a662a',
                borderWidth: 1,
                titleFont: {
                    family: "'Courier New', monospace"
                },
                bodyFont: {
                    family: "'Courier New', monospace"
                },
                callbacks: {
                    label: function(context) {
                        const point = context.raw;
                        return [
                            `r/${point.name}`,
                            `Subscribers: ${point.y.toLocaleString()}`,
                            `Posts (7d): ${point.x}`,
                            `Pop. Density: ${point.pop_density.toLocaleString()} per sq mi`
                        ];
                    }
                }
            }
        },
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Posts in Last 7 Days',
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace",
                        size: 14
                    }
                },
                grid: {
                    color: '#2a662a',
                    borderColor: '#2a662a'
                },
                ticks: {
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace"
                    }
                }
            },
            y: {
                title: {
                    display: true,
                    text: 'Subscribers',
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace",
                        size: 14
                    }
                },
                grid: {
                    color: '#2a662a',
                    borderColor: '#2a662a'
                },
                ticks: {
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace"
                    },
                    callback: function(value) {
                        return value.toLocaleString();
                    }
                }
            }
        }
    }
});

// === TAG CHART WITH STACKED BARS ===

// Get tag data from Django
const tagChartData = {{ tag_chart_data|safe }};
const subredditNames = {{ subreddit_names|safe }};

// Only initialize if we have data
if (tagChartData && subredditNames) {
    // Populate dropdown with subreddit names
    const dropdown = document.getElementById('subredditSelect');
    subredditNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = `r/${name}`;
        dropdown.appendChild(option);
    });
}

// Global variables to store chart instances
let tagChart = null;
let tagPercentChart = null;

// Function to update both charts when dropdown changes
function updateAllTagCharts() {
    updateTagPercentChart();
    updateTagChart();
}

// Function to update the PERCENTAGE chart based on dropdown selection
function updateTagPercentChart() {
    if (!tagChartData || !subredditNames) {
        console.log('Tag chart data not available');
        return;
    }
    
    const selectedSubreddit = document.getElementById('subredditSelect').value;
    
    // Prepare datasets
    let datasets = [];
    
    if (selectedSubreddit === 'all') {
        // Single dataset: percentages for all subreddits combined
        const percentages = tagChartData.tag_names.map((tagName, index) => {
            const tagCount = tagChartData.global_counts[index];
            const totalPosts = tagChartData.total_posts;
            return totalPosts > 0 ? (tagCount / totalPosts * 100) : 0;
        });
        
        datasets = [{
            label: 'All Subreddits',
            data: percentages,
            backgroundColor: '#00FF00',
            borderColor: '#00FF00',
            borderWidth: 1
        }];
    } else {
        // Two datasets: selected subreddit % + others % (both use global denominator)
        const selectedPercentages = [];
        const otherPercentages = [];
        
        tagChartData.tag_names.forEach((tagName, index) => {
            const globalCount = tagChartData.global_counts[index];
            const subredditCount = tagChartData.breakdown_by_subreddit[tagName][selectedSubreddit] || 0;
            const otherCount = globalCount - subredditCount;
            
            // Calculate percentages using TOTAL POSTS as denominator
            const totalPosts = tagChartData.total_posts;
            const selectedPercent = totalPosts > 0 ? (subredditCount / totalPosts * 100) : 0;
            const otherPercent = totalPosts > 0 ? (otherCount / totalPosts * 100) : 0;
            
            selectedPercentages.push(selectedPercent);
            otherPercentages.push(otherPercent);
        });
        
        datasets = [
            {
                label: `r/${selectedSubreddit}`,
                data: selectedPercentages,
                backgroundColor: '#00FF00',
                borderColor: '#00FF00',
                borderWidth: 1
            },
            {
                label: 'All Other Subreddits',
                data: otherPercentages,
                backgroundColor: '#2a662a',
                borderColor: '#2a662a',
                borderWidth: 1
            }
        ];
    }
    
    // Destroy existing chart if it exists
    if (tagPercentChart) {
        tagPercentChart.destroy();
    }
    
    // Create new percentage chart
    const percentCtx = document.getElementById('tagPercentChart').getContext('2d');
    tagPercentChart = new Chart(percentCtx, {
        type: 'bar',
        data: {
            labels: tagChartData.tag_names,
            datasets: datasets
        },
        options: {
            indexAxis: 'y',  // Horizontal bars
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: selectedSubreddit !== 'all',
                    labels: {
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace",
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: '#252525',
                    titleColor: '#00FF00',
                    bodyColor: '#00FF00',
                    borderColor: '#2a662a',
                    borderWidth: 1,
                    titleFont: {
                        family: "'Courier New', monospace"
                    },
                    bodyFont: {
                        family: "'Courier New', monospace"
                    },
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.x.toFixed(1) + '%';
                        },
                        footer: function(tooltipItems) {
                            if (selectedSubreddit === 'all') {
                                return '';
                            }
                            // Calculate total percentage
                            let total = 0;
                            tooltipItems.forEach(item => {
                                total += item.parsed.x;
                            });
                            return 'Total: ' + total.toFixed(1) + '%';
                        }
                    }
                }
            },
            scales: {
                x: {
                    stacked: true,
                    min: 0,
                    max: 100,  // Fixed scale 0-100%
                    grid: {
                        color: '#2a662a',
                        borderColor: '#2a662a'
                    },
                    ticks: {
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace",
                            size: 11
                        },
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    title: {
                        display: true,
                        text: 'Percentage of All Posts',
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace",
                            size: 12
                        }
                    }
                },
                y: {
                    stacked: true,
                    grid: {
                        color: '#2a662a',
                        borderColor: '#2a662a'
                    },
                    ticks: {
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace",
                            size: 11
                        }
                    }
                }
            }
        }
    });
}

// Function to update the COUNT chart based on dropdown selection
function updateTagChart() {
    if (!tagChartData || !subredditNames) {
        console.log('Tag chart data not available');
        return;
    }
    
    const selectedSubreddit = document.getElementById('subredditSelect').value;
    
    // Prepare datasets
    let datasets = [];
    
    if (selectedSubreddit === 'all') {
        // Single dataset: all subreddits combined
        datasets = [{
            label: 'All Subreddits',
            data: tagChartData.global_counts,
            backgroundColor: '#00FF00',
            borderColor: '#00FF00',
            borderWidth: 1
        }];
    } else {
        // Two datasets: selected subreddit + others
        const selectedCounts = [];
        const otherCounts = [];
        
        tagChartData.tag_names.forEach((tagName, index) => {
            const globalCount = tagChartData.global_counts[index];
            const subredditCount = tagChartData.breakdown_by_subreddit[tagName][selectedSubreddit] || 0;
            const otherCount = globalCount - subredditCount;
            
            selectedCounts.push(subredditCount);
            otherCounts.push(otherCount);
        });
        
        datasets = [
            {
                label: `r/${selectedSubreddit}`,
                data: selectedCounts,
                backgroundColor: '#00FF00',
                borderColor: '#00FF00',
                borderWidth: 1
            },
            {
                label: 'All Other Subreddits',
                data: otherCounts,
                backgroundColor: '#2a662a',
                borderColor: '#2a662a',
                borderWidth: 1
            }
        ];
    }
    
    // Destroy existing chart if it exists
    if (tagChart) {
        tagChart.destroy();
    }
    
    // Create new chart
    const tagCtx = document.getElementById('tagChart').getContext('2d');
    tagChart = new Chart(tagCtx, {
        type: 'bar',
        data: {
            labels: tagChartData.tag_names,
            datasets: datasets
        },
        options: {
            indexAxis: 'y',  // Horizontal bars
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: selectedSubreddit !== 'all',
                    labels: {
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace",
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: '#252525',
                    titleColor: '#00FF00',
                    bodyColor: '#00FF00',
                    borderColor: '#2a662a',
                    borderWidth: 1,
                    titleFont: {
                        family: "'Courier New', monospace"
                    },
                    bodyFont: {
                        family: "'Courier New', monospace"
                    },
                    callbacks: {
                        footer: function(tooltipItems) {
                            // Calculate total
                            let total = 0;
                            tooltipItems.forEach(item => {
                                total += item.parsed.x;
                            });
                            return 'Total: ' + total.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                x: {
                    stacked: true,  // Enable stacking
                    grid: {
                        color: '#2a662a',
                        borderColor: '#2a662a'
                    },
                    ticks: {
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace",
                            size: 11
                        }
                    },
                    title: {
                        display: true,
                        text: 'Number of Posts',
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace",
                            size: 12
                        }
                    }
                },
                y: {
                    stacked: true,  // Enable stacking
                    grid: {
                        color: '#2a662a',
                        borderColor: '#2a662a'
                    },
                    ticks: {
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace",
                            size: 11
                        }
                    }
                }
            }
        }
    });
}

// Initialize both charts on page load with "All Subreddits" only if we have data
if (tagChartData && subredditNames) {
    updateAllTagCharts();
}
</script>
{% endblock %}