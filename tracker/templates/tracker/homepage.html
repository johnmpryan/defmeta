{% extends "tracker/base.html" %}
{% load humanize %}

{% block title %}Reddit Stats - Homepage{% endblock %}

{% block extra_css %}
<style>
    /* Terminal-style subreddit display */
    .terminal-layout {
        background: #0a0a0a;
        border: 1px solid #2a662a;
        padding: 20px;
        margin: 20px 0;
    }
    
    /* Column Headers */
    .column-headers {
        display: flex;
        align-items: center;
        padding: 12px 0;
        border-bottom: 2px solid #00FF00;
        margin-bottom: 10px;
    }
    
    .header-cell {
        color: #00FF00;
        cursor: pointer;
        text-decoration: none;
        transition: opacity 0.2s;
    }
    
    .header-cell:hover {
        opacity: 0.7;
    }
    
    .header-name {
        min-width: 180px;
        margin-left: 25px; /* Account for prompt space */
    }
    
    .header-stats-container {
        display: flex;
        gap: 40px;
        margin-left: auto;
    }
    
    .header-stat {
        min-width: 90px;
        text-align: right;
    }
    
    /* Sort Arrow */
    .sort-arrow {
        margin-left: 5px;
        font-size: 12px;
    }
    
    .terminal-line {
        padding: 12px 0;
        border-bottom: 1px solid #1a1a1a;
        display: flex;
        align-items: center;
    }
    
    .terminal-line:last-child {
        border-bottom: none;
    }
    
    .terminal-line:hover {
        background: #151515;
    }
    
    .prompt {
        color: #00FF00;
        margin-right: 10px;
        font-weight: bold;
    }
    
    .terminal-name {
        color: #00FF00;
        text-decoration: underline;
        margin-right: 30px;
        min-width: 150px;
        display: inline-block;
    }
    
    .terminal-name:hover {
        opacity: 0.8;
    }
    
    .terminal-stats-container {
        display: flex;
        gap: 40px;
        flex-wrap: wrap;
    }
    
    .terminal-stat {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .stat-value {
        color: #00FF00;
        text-align: right;
        min-width: 90px;
    }
    
    .stat-label {
        color: #888;
        font-size: 12px;
    }
    
    /* Section Header */
    .section-header {
        color: #00FF00;
        font-size: 18px;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #333;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #888;
    }
    
    /* Pagination */
    .pagination {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 30px;
        align-items: center;
    }
    
    .page-btn {
        background: #252525;
        border: 1px solid #00FF00;
        color: #00FF00;
        padding: 8px 20px;
        text-decoration: none;
        transition: all 0.2s;
        font-family: 'Courier New', monospace;
        cursor: pointer;
    }
    
    .page-btn:hover {
        background: #00FF00;
        color: #1a1a1a;
    }
    
    .page-btn:disabled,
    .page-btn.disabled {
        opacity: 0.3;
        cursor: not-allowed;
        border-color: #333;
        color: #555;
    }
    
    .page-btn.disabled:hover {
        background: #252525;
        color: #555;
    }
    
    .page-info {
        color: #888;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
    <div class="section-header">TRACKED SUBREDDITS</div>
    
    <p class="description">This application tracks engagement across U.S. State subreddits. Activity snapshots are taken everynight for each subreddit. Subscribers count, post count, and daily comment count. The table below shows most recent subscriber and post count, as well as the number of 'snapshots' we have for each subreddit.</p>

    <p class="description">NOTE:  Improvements are planned to account for state timezone when polling for updates.</p>    

    {% if subreddit_data %}
        <div class="terminal-layout">
            <!-- Column Headers -->
            <div class="column-headers">
                <a href="?sort_by=name&order={% if current_sort == 'name' and current_order == 'desc' %}asc{% else %}desc{% endif %}" class="header-cell header-name">
                    Subreddit
                    {% if current_sort == 'name' %}
                        <span class="sort-arrow">{% if current_order == 'desc' %}↓{% else %}↑{% endif %}</span>
                    {% endif %}
                </a>
                <div class="header-stats-container">
                    <a href="?sort_by=subscribers&order={% if current_sort == 'subscribers' and current_order == 'desc' %}asc{% else %}desc{% endif %}" class="header-cell header-stat">
                        Subscribers
                        {% if current_sort == 'subscribers' %}
                            <span class="sort-arrow">{% if current_order == 'desc' %}↓{% else %}↑{% endif %}</span>
                        {% endif %}
                    </a>
                    <a href="?sort_by=snapshots&order={% if current_sort == 'snapshots' and current_order == 'desc' %}asc{% else %}desc{% endif %}" class="header-cell header-stat">
                        Snapshots
                        {% if current_sort == 'snapshots' %}
                            <span class="sort-arrow">{% if current_order == 'desc' %}↓{% else %}↑{% endif %}</span>
                        {% endif %}
                    </a>
                    <a href="?sort_by=posts&order={% if current_sort == 'posts' and current_order == 'desc' %}asc{% else %}desc{% endif %}" class="header-cell header-stat">
                        Posts
                        {% if current_sort == 'posts' %}
                            <span class="sort-arrow">{% if current_order == 'desc' %}↓{% else %}↑{% endif %}</span>
                        {% endif %}
                    </a>
                    <a href="?sort_by=score&order={% if current_sort == 'score' and current_order == 'desc' %}asc{% else %}desc{% endif %}" class="header-cell header-stat">
                        Avg Score
                        {% if current_sort == 'score' %}
                            <span class="sort-arrow">{% if current_order == 'desc' %}↓{% else %}↑{% endif %}</span>
                        {% endif %}
                    </a>
                </div>
            </div>
            
            <!-- Data Rows -->
            {% for item in subreddit_data %}
                <div class="terminal-line">
                    <span class="prompt">$</span>
                    <a href="/r/{{ item.subreddit.name }}/" class="terminal-name">r/{{ item.subreddit.name }}</a>
                    <div class="terminal-stats-container">
                        <div class="terminal-stat">
                            <span class="stat-value">
                                {% if item.latest_snapshot %}
                                    {{ item.latest_snapshot.subscribers_count|default_if_none:"N/A"|intcomma }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </span>
                        </div>
                        <div class="terminal-stat">
                            <a href="/r/{{ item.subreddit.name }}/" class="stat-value">
                                {{ item.snapshot_count|intcomma }}
                            </a>
                        </div>
                        <div class="terminal-stat">
                            <span class="stat-value">
                                {% if item.latest_snapshot %}
                                    {{ item.latest_snapshot.posts_count|default_if_none:"N/A"|intcomma }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </span>
                        </div>
                        <div class="terminal-stat">
                            <span class="stat-value">
                                {% if item.latest_snapshot %}
                                    {{ item.latest_snapshot.avg_post_score|default_if_none:"N/A"|floatformat:0|intcomma }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="empty-state">
                    <p>No subreddits tracked yet.</p>
                </div>
            {% endfor %}
        </div>
        
        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}&sort_by={{ current_sort }}&order={{ current_order }}" class="page-btn">← Previous</a>
            {% else %}
                <span class="page-btn disabled">← Previous</span>
            {% endif %}
            
            <span class="page-info">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
            
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}&sort_by={{ current_sort }}&order={{ current_order }}" class="page-btn">Next →</a>
            {% else %}
                <span class="page-btn disabled">Next →</span>
            {% endif %}
        </div>
        {% endif %}
    {% else %}
        <div class="empty-state">
            <p>No subreddits tracked yet.</p>
        </div>
    {% endif %}
{% endblock %}