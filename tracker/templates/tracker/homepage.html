{% extends "tracker/base.html" %}
{% load humanize %}

{% block title %}Reddit Stats - Homepage{% endblock %}

{% block extra_css %}
<style>
    /* ===== TAB NAVIGATION ===== */
    .tab-container {
        display: flex;
        gap: 0;
        margin-bottom: 0;
        border-bottom: 2px solid #2a662a;
    }
    
    .tab-button {
        background: #1a1a1a;
        color: #888;
        border: 2px solid #2a662a;
        border-bottom: none;
        padding: 10px 30px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .tab-button:hover {
        background: #252525;
        color: #00FF00;
    }
    
    .tab-button.active {
        background: #252525;
        color: #00FF00;
        border-bottom: 2px solid #252525;
        margin-bottom: -2px;
    }
    
    .tab-content {
        display: none;
        padding: 30px;
    }
    
    .tab-content.active {
        display: block;
    }
    
    /* ===== RANKINGS TAB STYLING ===== */
    .rankings-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .ranking-metric-btn {
        background: #252525;
        border: 1px solid #2a662a;
        color: #888;
        padding: 10px 20px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .ranking-metric-btn:hover {
        border-color: #00FF00;
        color: #00FF00;
    }
    
    .ranking-metric-btn.active {
        background: #00FF00;
        color: #1a1a1a;
        border-color: #00FF00;
    }
    
    .rankings-header {
        grid-template-columns: 80px 200px 1fr;
    }
    
    .rankings-row {
        display: grid;
        grid-template-columns: 80px 200px 1fr;
        padding: 12px 0;
        border-bottom: 1px solid #1a1a1a;
        align-items: center;
    }
    
    .rankings-row:hover {
        background: #151515;
    }
    
    .rank-col {
        color: #888;
        font-weight: bold;
    }
    
    .rankings-row .rank-col {
        color: #00FF00;
    }
    
    .name-col a {
        color: #00FF00;
        text-decoration: underline;
    }
    
    .value-col {
        text-align: right;
        color: #00FF00;
    }
    
    /* Top 3 highlighting */
    .rankings-row.top-1 .rank-col { color: #FFD700; }
    .rankings-row.top-2 .rank-col { color: #C0C0C0; }
    .rankings-row.top-3 .rank-col { color: #CD7F32; }
    
    /* ===== CHART STYLING ===== */
    .chart-container {
        position: relative;
        height: 400px;
        margin: 20px 0;
    }
    
    /* ===== DROPDOWN STYLING ===== */
    .subreddit-selector {
        margin: 20px 0;
    }
    
    .subreddit-selector label {
        color: #00FF00;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        margin-right: 10px;
    }
    
    .subreddit-selector select {
        background: #252525;
        color: #00FF00;
        border: 1px solid #2a662a;
        padding: 8px 15px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        cursor: pointer;
        min-width: 200px;
    }
    
    .subreddit-selector select:focus {
        outline: none;
        border-color: #00FF00;
    }
    
    /* ===== EXPLORE TAB CONTROLS ===== */
    .explore-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
        padding: 20px;
        background: #151515;
        border: 1px solid #2a662a;
    }
    
    .control-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .control-group label {
        color: #00FF00;
        font-family: 'Courier New', monospace;
        font-size: 12px;
    }
    
    .control-group select {
        background: #252525;
        color: #00FF00;
        border: 1px solid #2a662a;
        padding: 8px 12px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        cursor: pointer;
        min-width: 180px;
    }
    
    .control-group select:focus {
        outline: none;
        border-color: #00FF00;
    }
    
    /* ===== EXPLORE LEADERBOARD TABLE ===== */
    .explore-table-container {
        margin-top: 40px;
        overflow-x: auto;
    }
    
    .explore-table {
        width: 100%;
        border-collapse: collapse;
        font-family: 'Courier New', monospace;
        font-size: 13px;
    }
    
    .explore-table th {
        color: #00FF00;
        text-align: left;
        padding: 12px 8px;
        border-bottom: 2px solid #00FF00;
        cursor: pointer;
        white-space: nowrap;
    }
    
    .explore-table th:hover {
        background: #252525;
    }
    
    .explore-table th.sorted-asc::after {
        content: ' ↑';
    }
    
    .explore-table th.sorted-desc::after {
        content: ' ↓';
    }
    
    .explore-table td {
        color: #00FF00;
        padding: 10px 8px;
        border-bottom: 1px solid #1a1a1a;
    }
    
    .explore-table tr:hover {
        background: #151515;
    }
    
    .explore-table .subreddit-link {
        color: #00FF00;
        text-decoration: underline;
    }
    
    .explore-table .tier-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 11px;
        margin-left: 5px;
    }
    
    .tier-1 { background: #1a3d1a; }
    .tier-2 { background: #2a4d2a; }
    .tier-3 { background: #3a5d3a; }
    .tier-4 { background: #4a6d4a; }
    .tier-5 { background: #5a7d5a; }
    
    /* ===== HOMEPAGE-SPECIFIC TABLE LAYOUT ===== */
    
    /* Desktop: prompt (25px) + name (180px) + 4 stat columns */
    .table-header {
        grid-template-columns: 25px 180px 1fr;
    }
    
    .header-stats {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .table-row {
        grid-template-columns: 25px 180px 1fr;
    }
    
    .row-stats {
        grid-template-columns: repeat(4, 1fr);
    }
    
    /* ===== RESPONSIVE: MOBILE ===== */
    
    /* Tablet/Mobile: Show only name and subscribers */
    @media (max-width: 768px) {
        .table-header {
            grid-template-columns: 25px 1fr 140px;
        }
        
        .header-stats {
            grid-template-columns: 1fr;
        }
        
        /* Hide all stats except subscribers in header */
        .header-stats .header-cell:not(.header-subscribers) {
            display: none;
        }
        
        .table-row {
            grid-template-columns: 25px 1fr 140px;
        }
        
        .row-stats {
            grid-template-columns: 1fr;
        }
        
        /* Hide all stats except subscribers in rows */
        .row-stats .stat-value:not(.stat-subscribers) {
            display: none;
        }
        
        .explore-controls {
            flex-direction: column;
        }
        
        .rankings-header,
        .rankings-row {
            grid-template-columns: 50px 1fr 80px;
        }
        
        .ranking-metric-btn {
            padding: 8px 12px;
            font-size: 12px;
        }
    }
    
    /* Very small mobile: Tighten spacing further */
    @media (max-width: 480px) {
        .table-header {
            grid-template-columns: 20px 1fr 100px;
            gap: 10px;
        }
        
        .table-row {
            grid-template-columns: 20px 1fr 100px;
            gap: 10px;
        }
        
        .row-name {
            font-size: 14px;
        }
        
        .header-name,
        .header-cell {
            font-size: 14px;
        }
        
        .tab-button {
            padding: 8px 15px;
            font-size: 11px;
        }
    }
</style>
{% endblock %}

{% block content %}
    <div class="section-header">TRACKED SUBREDDITS</div>

    <p class="description">This application tracks engagement across U.S. State subreddits, using automated data collection, aggregation, and AI-powered content analysis.</p>

    <p class="description"><strong>Explore the data:</strong> From the homepage, view how population affects engagement or compare what content is most frequently posted. Click any subreddit to view historical snapshot data and individual posts with AI-generated content tags. </p>

    <p class="description"><strong>Nightly automated pipeline [<a href="https://github.com/johnmpryan/defmeta">Github repo</a>]:</strong><br>
    <strong>• Data collection:</strong> Reddit API retrieves subscriber counts and all posts from the previous day<br>
    <strong>• AI tagging:</strong> Claude analyzes post content and assigns categorical tags (topic, content type, sentiment)<br>
    <strong>• Engagement tracking:</strong> Posts 3+ days old are updated with scores, comments, and vote estimates<br>
    <strong>• Aggregation:</strong> Post-level metrics are rolled up into daily subreddit snapshots</p>


    <p class="description">Check back often. Data collection began in early October. New analysis and data points being added regularly.</p>

    <!-- Tab Navigation -->
    <div class="terminal-table-container" style="margin-top: 30px;">
        <div class="tab-container">
            <button class="tab-button active" onclick="switchTab(event, 'rankings')">RANKINGS</button>
            <button class="tab-button" onclick="switchTab(event, 'pop_effects')">POPULATION EFFECTS</button>
            <button class="tab-button" onclick="switchTab(event, 'content')">CONTENT ANALYSIS</button>
            <button class="tab-button" onclick="switchTab(event, 'explore')">DATA EXPLORER</button>
            <button class="tab-button" onclick="switchTab(event, 'data')">SUBREDDIT DATA</button>
        </div>
        
        <!-- RANKINGS Tab Content -->
        <div id="rankings-tab" class="tab-content active">
            <p class="description">Rankings based on 7-day rolling averages. Select a metric to re-rank.</p>
            
            <!-- Metric Selector -->
            <div class="rankings-controls">
                <button class="ranking-metric-btn active" data-metric="posts" onclick="switchRankingMetric('posts', this)">Posts/Day</button>
                <button class="ranking-metric-btn" data-metric="subscribers" onclick="switchRankingMetric('subscribers', this)">Subscribers</button>
                <button class="ranking-metric-btn" data-metric="score" onclick="switchRankingMetric('score', this)">Avg Score</button>
                <button class="ranking-metric-btn" data-metric="comments" onclick="switchRankingMetric('comments', this)">Comments/Post</button>
            </div>
            
            <!-- Rankings Table -->
            <div class="terminal-table-container" style="border: none; padding: 0; margin: 0; width: 100%;">
                <div class="terminal-table">
                    <div class="table-header rankings-header">
                        <div class="header-cell rank-col">Rank</div>
                        <div class="header-cell name-col">Subreddit</div>
                        <div class="header-cell value-col" id="rankings-value-header">Posts/Day</div>
                    </div>
                    <div id="rankings-table-body">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <p class="description" style="margin-top: 20px; font-size: 11px;">
                Data as of {{ rankings_date }}. D.C. excluded from rankings.
            </p>
        </div>
        
        <!-- POPULATION EFFECTS Tab Content -->
        <div id="pop_effects-tab" class="tab-content">
            <p class="description">Below shows the interaction between a State's population and its subreddit's subscriber and recent post counts. <strong>While a greater state population seems to lead to greater subscriber counts, it does not seem to insure greater post engagement.</strong>[future research: pop affect on like and comment engagement, New Jersey]</p>
            <h2 style="color: #00FF00; margin-bottom: 20px;">Recent Post Activity vs Subscribers by State Population</h2>
            <div class="chart-container" style="height: 600px;">
                <canvas id="bubbleChart"></canvas>
            </div>
            <p class="description">But by factoring in crude population density, a slightly more clear pattern emerges. States with greater population density seem to have more post engagement. But this signal is still mixed, with low density states still reaching the upper measures of post engagement. [future research: affects between state and city subreddits, New Jersey, other measures of density: metro areas over XXXX,]</p>

            <h2 style="color: #00FF00; margin: 40px 0 20px;">Recent Post Activity vs Subscribers by Population Density</h2>
            <p class="description">District of Columbia excluded, pop density 10x greater than next closest. <p>
            <div class="chart-container" style="height: 600px;">
                <canvas id="densityBubbleChart"></canvas>
            </div>
            
            <h2 style="color: #00FF00; margin: 40px 0 20px;">Total Subscribers Across All State Subreddits</h2>
            <div class="chart-container">
                <canvas id="totalSubscribersChart"></canvas>
            </div>
        </div>
        
        <!-- CONTENT ANALYSIS Tab Content -->
        <div id="content-tab" class="tab-content">
            <h2 style="color: #00FF00; margin-bottom: 20px;">Top Topics - Last 7 Days</h2>

            <p class="description">Select a subreddit to see how its tag usage compares to all other state subreddits. The charts show the top 20 tags globally from the last 7 days.</p>
            
            <!-- Subreddit Dropdown (shared by both charts) -->
            <div class="subreddit-selector">
                <label for="subredditSelect1">Compare:</label>
                <select id="subredditSelect1" onchange="updateAllTagCharts()">
                    <option value="all">All Subreddits (National)</option>
                </select>
    
                <label for="subredditSelect2" style="margin-left: 20px;">To:</label>
                <select id="subredditSelect2" onchange="updateAllTagCharts()">
                    <option value="other">All Other Subreddits</option>
                    <option value="none" disabled>──────────</option>
                </select>
            </div>
            
            <!-- Percentage Chart -->
            <h3 style="color: #00FF00; margin: 30px 0 10px;">Tag Prevalence (% of Posts)</h3>
            <p class="description" style="margin-bottom: 20px;">Shows what percentage of posts are tagged with each topic.</p>
            <div class="chart-container" style="height: 600px;">
                <canvas id="tagPercentChart"></canvas>
            </div>
            
            <!-- Count Chart -->
            <h3 style="color: #00FF00; margin: 40px 0 10px;">Tag Usage (Post Count)</h3>
            <p class="description" style="margin-bottom: 20px;">Shows the raw number of posts tagged with each topic.</p>
            <div class="chart-container" style="height: 600px;">
                <canvas id="tagChart"></canvas>
            </div>
        </div>
        
        <!-- EXPLORE Tab Content -->
        <div id="explore-tab" class="tab-content">
            <h2 style="color: #00FF00; margin-bottom: 20px;">Explore Engagement Metrics</h2>
            
            <p class="description">Compare subreddits using different metrics and dimensions. Select X and Y axes to plot relationships, and color by region or tier to discover patterns.</p>
            
            <!-- Controls -->
            <div class="explore-controls">
                <div class="control-group">
                    <label for="exploreXAxis">X-Axis:</label>
                    <select id="exploreXAxis" onchange="updateExploreChart()">
                        <option value="population">Population</option>
                        <option value="pop_density">Population Density</option>
                        <option value="subscribers">Subscribers</option>
                        <option value="posts_7d">Posts (7d)</option>
                        <option value="comments_7d">Comments (7d)</option>
                        <option value="upvotes_7d">Upvotes (7d)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="exploreYAxis">Y-Axis:</label>
                    <select id="exploreYAxis" onchange="updateExploreChart()">
                        <option value="posts_7d">Posts (7d)</option>
                        <option value="comments_7d">Comments (7d)</option>
                        <option value="upvotes_7d">Upvotes (7d)</option>
                        <option value="subscribers">Subscribers</option>
                        <option value="subs_per_10k_pop" selected>Subscribers per 10k Pop</option>
                        <option value="posts_per_10k_pop">Posts per 10k Pop</option>
                        <option value="posts_per_1k_subs">Posts per 1k Subs</option>
                        <option value="comments_per_1k_subs">Comments per 1k Subs</option>
                        <option value="upvotes_per_1k_subs">Upvotes per 1k Subs</option>
                        <option value="comments_per_post">Comments per Post</option>
                        <option value="upvotes_per_post">Upvotes per Post</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="exploreColorBy">Color By:</label>
                    <select id="exploreColorBy" onchange="updateExploreChart()">
                        <option value="none">None (all green)</option>
                        <option value="region" selected>Region</option>
                        <option value="pop_tier">Population Tier</option>
                        <option value="density_tier">Density Tier</option>
                    </select>
                </div>
            </div>
            
            <!-- Scatter Chart -->
            <div class="chart-container" style="height: 500px;">
                <canvas id="exploreScatterChart"></canvas>
            </div>
            
            <!-- Leaderboard Table -->
            <div class="explore-table-container">
                <h3 style="color: #00FF00; margin: 30px 0 15px;">Metrics Leaderboard (7-Day Window)</h3>
                <p class="description" style="margin-bottom: 15px;">Click column headers to sort. Tier 1 = smallest, Tier 5 = largest.</p>
                
                <table class="explore-table" id="exploreTable">
                    <thead>
                        <tr>
                            <th data-sort="name">Subreddit</th>
                            <th data-sort="region">Region</th>
                            <th data-sort="pop_tier">Pop Tier</th>
                            <th data-sort="subscribers">Subs</th>
                            <th data-sort="subs_per_10k_pop">Subs/10k Pop</th>
                            <th data-sort="posts_7d">Posts</th>
                            <th data-sort="posts_per_1k_subs">Posts/1k Subs</th>
                            <th data-sort="comments_per_1k_subs">Cmts/1k Subs</th>
                            <th data-sort="upvotes_per_1k_subs">Upv/1k Subs</th>
                            <th data-sort="comments_per_post">Cmts/Post</th>
                        </tr>
                    </thead>
                    <tbody id="exploreTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- SUBREDDIT DATA Tab Content -->
        <div id="data-tab" class="tab-content">
            <p class="description">The table below shows most recent subscriber and post counts, as well as the count of daily 'snapshots'. Snapshots can be viewed by clicking on subreddit name.</p>
            
            {% if subreddit_data %}
                <div class="terminal-table">
                    <!-- Header Row -->
                    <div class="table-header">
                        <div class="header-prompt"></div>
                        <a href="?sort_by=name&order={% if current_sort == 'name' and current_order == 'desc' %}asc{% else %}desc{% endif %}" class="header-name">
                            Subreddit
                            {% if current_sort == 'name' %}
                                <span class="sort-arrow">{% if current_order == 'desc' %}↓{% else %}↑{% endif %}</span>
                            {% endif %}
                        </a>
                        <div class="header-stats">
                            <a href="?sort_by=subscribers&order={% if current_sort == 'subscribers' and current_order == 'desc' %}asc{% else %}desc{% endif %}" class="header-cell header-subscribers">
                                Subscribers
                                {% if current_sort == 'subscribers' %}
                                    <span class="sort-arrow">{% if current_order == 'desc' %}↓{% else %}↑{% endif %}</span>
                                {% endif %}
                            </a>
                            <a href="?sort_by=per_capita&order={% if current_sort == 'per_capita' and current_order == 'desc' %}asc{% else %}desc{% endif %}" class="header-cell header-per-capita">
                                Per 10k pop.
                                {% if current_sort == 'per_capita' %}
                                    <span class="sort-arrow">{% if current_order == 'desc' %}↓{% else %}↑{% endif %}</span>
                                {% endif %}
                            </a>
                            <a href="?sort_by=snapshots&order={% if current_sort == 'snapshots' and current_order == 'desc' %}asc{% else %}desc{% endif %}" class="header-cell header-snapshots">
                                Snapshots
                                {% if current_sort == 'snapshots' %}
                                    <span class="sort-arrow">{% if current_sort == 'snapshots' %}↓{% else %}↑{% endif %}</span>
                                {% endif %}
                            </a>
                        </div>
                    </div>
                    
                    <!-- Data Rows -->
                    {% for item in subreddit_data %}
                        <div class="table-row">
                            <span class="row-prompt">$</span>
                            <a href="/r/{{ item.subreddit.name }}/" class="row-name">r/{{ item.subreddit.name }}</a>
                            <div class="row-stats">
                                <div class="stat-value stat-subscribers">
                                    {% if item.latest_snapshot %}
                                        {{ item.latest_snapshot.subscribers_count|default_if_none:"N/A"|intcomma }}
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </div>
                                <div class="stat-value stat-per-capita">
                                    {{ item.per_capita|default_if_none:"N/A"|floatformat:0 }}
                                </div>
                                <div class="stat-value stat-snapshots">
                                    <a href="/r/{{ item.subreddit.name }}/">
                                        {{ item.snapshot_count|intcomma }}
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="empty-state">
                            <p>No subreddits tracked yet.</p>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                <div class="pagination">
                    {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}&sort_by={{ current_sort }}&order={{ current_order }}" class="page-btn">← Previous</a>
                    {% else %}
                        <span class="page-btn disabled">← Previous</span>
                    {% endif %}
                    
                    <span class="page-info">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                    
                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}&sort_by={{ current_sort }}&order={{ current_order }}" class="page-btn">Next →</a>
                    {% else %}
                        <span class="page-btn disabled">Next →</span>
                    {% endif %}
                </div>
                {% endif %}
            {% else %}
                <div class="empty-state">
                    <p>No subreddits tracked yet.</p>
                </div>
            {% endif %}
        </div>
    </div>

<script>
function switchTab(event, tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active state from all buttons
    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Activate clicked button
    event.target.classList.add('active');
}

// === RANKINGS TAB FUNCTIONALITY ===

// Rankings data from Django
const rankingsData = {{ rankings_data|safe }};

// Metric configuration
const metricConfig = {
    'posts': {
        valueField: 'posts_7day_avg',
        rankField: 'posts_7day_rank',
        header: 'Posts/Day',
        decimals: 1
    },
    'subscribers': {
        valueField: 'subscribers_7day_avg',
        rankField: 'subscribers_7day_rank',
        header: 'Subscribers',
        decimals: 0
    },
    'score': {
        valueField: 'score_7day_avg',
        rankField: 'score_7day_rank',
        header: 'Avg Score',
        decimals: 1
    },
    'comments': {
        valueField: 'comments_7day_avg',
        rankField: 'comments_7day_rank',
        header: 'Comments/Post',
        decimals: 1
    }
};

function switchRankingMetric(metric, button) {
    // Update active button
    document.querySelectorAll('.ranking-metric-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    button.classList.add('active');
    
    // Update header
    document.getElementById('rankings-value-header').textContent = metricConfig[metric].header;
    
    // Re-render table
    renderRankingsTable(metric);
}

function renderRankingsTable(metric) {
    const config = metricConfig[metric];
    const tableBody = document.getElementById('rankings-table-body');
    
    // Sort by rank
    const sortedData = [...rankingsData].sort((a, b) => {
        const rankA = a[config.rankField] || 999;
        const rankB = b[config.rankField] || 999;
        return rankA - rankB;
    });
    
    // Build HTML
    let html = '';
    sortedData.forEach(item => {
        const rank = item[config.rankField];
        const value = item[config.valueField];
        
        // Format value
        let formattedValue = 'N/A';
        if (value !== null && value !== undefined) {
            formattedValue = config.decimals === 0 
                ? Math.round(value).toLocaleString()
                : value.toFixed(config.decimals);
        }
        
        // Top 3 class
        let topClass = '';
        if (rank === 1) topClass = 'top-1';
        else if (rank === 2) topClass = 'top-2';
        else if (rank === 3) topClass = 'top-3';
        
        html += `
            <div class="rankings-row ${topClass}">
                <div class="rank-col">#${rank || 'N/A'}</div>
                <div class="name-col"><a href="/r/${item.name}/">r/${item.name}</a></div>
                <div class="value-col">${formattedValue}</div>
            </div>
        `;
    });
    
    tableBody.innerHTML = html;
}

// Initialize rankings table on page load
document.addEventListener('DOMContentLoaded', function() {
    if (rankingsData && rankingsData.length > 0) {
        renderRankingsTable('posts');
    }
});

// === END RANKINGS TAB FUNCTIONALITY ===

// Chart.js configuration for terminal aesthetic
Chart.defaults.color = '#00FF00';
Chart.defaults.borderColor = '#2a662a';

// LINE CHART: Total Subscribers Over Time
const lineChartData = {{ line_chart_data|safe }};

const lineCtx = document.getElementById('totalSubscribersChart').getContext('2d');
const totalSubscribersChart = new Chart(lineCtx, {
    type: 'line',
    data: {
        labels: lineChartData.labels,
        datasets: [{
            label: 'Total Subscribers',
            data: lineChartData.data,
            borderColor: '#00FF00',
            backgroundColor: 'rgba(0, 255, 0, 0.1)',
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: '#00FF00',
            pointBorderColor: '#00FF00',
            pointHoverRadius: 6,
            pointHoverBackgroundColor: '#00FF00',
            pointHoverBorderColor: '#1a1a1a',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                labels: {
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace",
                        size: 12
                    }
                }
            },
            tooltip: {
                backgroundColor: '#252525',
                titleColor: '#00FF00',
                bodyColor: '#00FF00',
                borderColor: '#2a662a',
                borderWidth: 1,
                titleFont: {
                    family: "'Courier New', monospace"
                },
                bodyFont: {
                    family: "'Courier New', monospace"
                },
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        label += context.parsed.y.toLocaleString();
                        return label;
                    }
                }
            }
        },
        scales: {
            x: {
                grid: {
                    color: '#2a662a',
                    borderColor: '#2a662a'
                },
                ticks: {
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace",
                        size: 11
                    }
                }
            },
            y: {
                grid: {
                    color: '#2a662a',
                    borderColor: '#2a662a'
                },
                ticks: {
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace",
                        size: 11
                    },
                    callback: function(value) {
                        return value.toLocaleString();
                    }
                }
            }
        }
    }
});

// BUBBLE CHART 1: Activity vs Subscribers by State Population
const bubbleData = {{ bubble_chart_data|safe }};

const bubbleCtx = document.getElementById('bubbleChart').getContext('2d');
const bubbleChart = new Chart(bubbleCtx, {
    type: 'bubble',
    data: {
        datasets: [{
            label: 'State Subreddits',
            data: bubbleData,
            backgroundColor: 'rgba(0, 255, 0, 0.2)',
            borderColor: '#00FF00',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: '#252525',
                titleColor: '#00FF00',
                bodyColor: '#00FF00',
                borderColor: '#2a662a',
                borderWidth: 1,
                titleFont: {
                    family: "'Courier New', monospace"
                },
                bodyFont: {
                    family: "'Courier New', monospace"
                },
                callbacks: {
                    label: function(context) {
                        const point = context.raw;
                        return [
                            `r/${point.name}`,
                            `Subscribers: ${point.y.toLocaleString()}`,
                            `Posts (7d): ${point.x}`,
                            `Population: ${point.population.toLocaleString()}`
                        ];
                    }
                }
            }
        },
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Posts in Last 7 Days',
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace",
                        size: 14
                    }
                },
                grid: {
                    color: '#2a662a',
                    borderColor: '#2a662a'
                },
                ticks: {
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace"
                    }
                }
            },
            y: {
                title: {
                    display: true,
                    text: 'Subscribers',
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace",
                        size: 14
                    }
                },
                grid: {
                    color: '#2a662a',
                    borderColor: '#2a662a'
                },
                ticks: {
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace"
                    },
                    callback: function(value) {
                        return value.toLocaleString();
                    }
                }
            }
        }
    }
});

// BUBBLE CHART 2: Activity vs Subscribers by Population Density
const densityBubbleData = {{ density_bubble_chart_data|safe }};

const densityBubbleCtx = document.getElementById('densityBubbleChart').getContext('2d');
const densityBubbleChart = new Chart(densityBubbleCtx, {
    type: 'bubble',
    data: {
        datasets: [{
            label: 'State Subreddits by Density',
            data: densityBubbleData,
            backgroundColor: 'rgba(0, 255, 0, 0.2)',
            borderColor: '#00FF00',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: '#252525',
                titleColor: '#00FF00',
                bodyColor: '#00FF00',
                borderColor: '#2a662a',
                borderWidth: 1,
                titleFont: {
                    family: "'Courier New', monospace"
                },
                bodyFont: {
                    family: "'Courier New', monospace"
                },
                callbacks: {
                    label: function(context) {
                        const point = context.raw;
                        return [
                            `r/${point.name}`,
                            `Subscribers: ${point.y.toLocaleString()}`,
                            `Posts (7d): ${point.x}`,
                            `Pop. Density: ${point.pop_density.toLocaleString()} per sq mi`
                        ];
                    }
                }
            }
        },
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Posts in Last 7 Days',
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace",
                        size: 14
                    }
                },
                grid: {
                    color: '#2a662a',
                    borderColor: '#2a662a'
                },
                ticks: {
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace"
                    }
                }
            },
            y: {
                title: {
                    display: true,
                    text: 'Subscribers',
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace",
                        size: 14
                    }
                },
                grid: {
                    color: '#2a662a',
                    borderColor: '#2a662a'
                },
                ticks: {
                    color: '#00FF00',
                    font: {
                        family: "'Courier New', monospace"
                    },
                    callback: function(value) {
                        return value.toLocaleString();
                    }
                }
            }
        }
    }
});

// === TAG CHART WITH STACKED BARS ===

// Get tag data from Django
const tagChartData = {{ tag_chart_data|safe }};
const subredditNames = {{ subreddit_names|safe }};

// Only initialize if we have data
if (tagChartData && subredditNames) {
    // Populate both dropdowns with subreddit names
    const dropdown1 = document.getElementById('subredditSelect1');
    const dropdown2 = document.getElementById('subredditSelect2');
    
    subredditNames.forEach(name => {
        // Add to first dropdown
        const option1 = document.createElement('option');
        option1.value = name;
        option1.textContent = `r/${name}`;
        dropdown1.appendChild(option1);
        
        // Add to second dropdown
        const option2 = document.createElement('option');
        option2.value = name;
        option2.textContent = `r/${name}`;
        dropdown2.appendChild(option2);
    });
}

// Global variables to store chart instances
let tagChart = null;
let tagPercentChart = null;

// Function to update both charts when dropdown changes
function updateAllTagCharts() {
    updateTagPercentChart();
    updateTagChart();
}

// Function to update the PERCENTAGE chart based on dropdown selection
function updateTagPercentChart() {
    if (!tagChartData || !subredditNames) {
        console.log('Tag chart data not available');
        return;
    }
    
    const selected1 = document.getElementById('subredditSelect1').value;
    const selected2 = document.getElementById('subredditSelect2').value;
    
    // Prepare datasets
    let datasets = [];
    
    if (selected1 === 'all' && selected2 === 'other') {
        // Default: all subreddits combined
        const percentages = tagChartData.tag_names.map((tagName, index) => {
            const tagCount = tagChartData.global_counts[index];
            const totalPosts = tagChartData.total_posts;
            return totalPosts > 0 ? (tagCount / totalPosts * 100) : 0;
        });
        
        datasets = [{
            label: 'All Subreddits',
            data: percentages,
            backgroundColor: '#00FF00',
            borderColor: '#00FF00',
            borderWidth: 1
        }];
    } else if (selected1 === 'all') {
        // National vs specific subreddit
        const selectedPercentages = [];
        const otherPercentages = [];
        
        const selectedSubredditTotalPosts = tagChartData.posts_per_subreddit[selected2] || 0;
        const otherSubredditsTotalPosts = tagChartData.total_posts - selectedSubredditTotalPosts;
        
        tagChartData.tag_names.forEach((tagName, index) => {
            const globalCount = tagChartData.global_counts[index];
            const subredditCount = tagChartData.breakdown_by_subreddit[tagName][selected2] || 0;
            const otherCount = globalCount - subredditCount;
            
            const selectedPercent = selectedSubredditTotalPosts > 0 ? (subredditCount / selectedSubredditTotalPosts * 100) : 0;
            const otherPercent = otherSubredditsTotalPosts > 0 ? (otherCount / otherSubredditsTotalPosts * 100) : 0;
            
            selectedPercentages.push(selectedPercent);
            otherPercentages.push(otherPercent);
        });
        
        datasets = [
            {
                label: `r/${selected2}`,
                data: selectedPercentages,
                backgroundColor: '#00FF00',
                borderColor: '#00FF00',
                borderWidth: 1
            },
            {
                label: 'All Other Subreddits',
                data: otherPercentages,
                backgroundColor: '#2a662a',
                borderColor: '#2a662a',
                borderWidth: 1
            }
        ];
    } else if (selected2 === 'other') {
        // Specific subreddit vs all others
        const selectedPercentages = [];
        const otherPercentages = [];
        
        const selectedSubredditTotalPosts = tagChartData.posts_per_subreddit[selected1] || 0;
        const otherSubredditsTotalPosts = tagChartData.total_posts - selectedSubredditTotalPosts;
        
        tagChartData.tag_names.forEach((tagName, index) => {
            const globalCount = tagChartData.global_counts[index];
            const subredditCount = tagChartData.breakdown_by_subreddit[tagName][selected1] || 0;
            const otherCount = globalCount - subredditCount;
            
            const selectedPercent = selectedSubredditTotalPosts > 0 ? (subredditCount / selectedSubredditTotalPosts * 100) : 0;
            const otherPercent = otherSubredditsTotalPosts > 0 ? (otherCount / otherSubredditsTotalPosts * 100) : 0;
            
            selectedPercentages.push(selectedPercent);
            otherPercentages.push(otherPercent);
        });
        
        datasets = [
            {
                label: `r/${selected1}`,
                data: selectedPercentages,
                backgroundColor: '#00FF00',
                borderColor: '#00FF00',
                borderWidth: 1
            },
            {
                label: 'All Other Subreddits',
                data: otherPercentages,
                backgroundColor: '#2a662a',
                borderColor: '#2a662a',
                borderWidth: 1
            }
        ];
    } else {
        // Two specific subreddits
        const percentages1 = [];
        const percentages2 = [];
        
        const totalPosts1 = tagChartData.posts_per_subreddit[selected1] || 0;
        const totalPosts2 = tagChartData.posts_per_subreddit[selected2] || 0;
        
        tagChartData.tag_names.forEach((tagName) => {
            const count1 = tagChartData.breakdown_by_subreddit[tagName][selected1] || 0;
            const count2 = tagChartData.breakdown_by_subreddit[tagName][selected2] || 0;
            
            const percent1 = totalPosts1 > 0 ? (count1 / totalPosts1 * 100) : 0;
            const percent2 = totalPosts2 > 0 ? (count2 / totalPosts2 * 100) : 0;
            
            percentages1.push(percent1);
            percentages2.push(percent2);
        });
        
        datasets = [
            {
                label: `r/${selected1}`,
                data: percentages1,
                backgroundColor: '#00FF00',
                borderColor: '#00FF00',
                borderWidth: 1
            },
            {
                label: `r/${selected2}`,
                data: percentages2,
                backgroundColor: '#2a662a',
                borderColor: '#2a662a',
                borderWidth: 1
            }
        ];
    }
    
    // Destroy existing chart if it exists
    if (tagPercentChart) {
        tagPercentChart.destroy();
    }
    
    // Create new percentage chart
    const percentCtx = document.getElementById('tagPercentChart').getContext('2d');
    tagPercentChart = new Chart(percentCtx, {
        type: 'bar',
        data: {
            labels: tagChartData.tag_names,
            datasets: datasets
        },
        options: {
            indexAxis: 'y',  // Horizontal bars
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: datasets.length > 1,
                    labels: {
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace",
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: '#252525',
                    titleColor: '#00FF00',
                    bodyColor: '#00FF00',
                    borderColor: '#2a662a',
                    borderWidth: 1,
                    titleFont: {
                        family: "'Courier New', monospace"
                    },
                    bodyFont: {
                        family: "'Courier New', monospace"
                    },
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.x.toFixed(1) + '%';
                        }
                    }
                }
            },
            scales: {
                x: {
                    stacked: false,
                    min: 0,
                    grid: {
                        color: '#2a662a',
                        borderColor: '#2a662a'
                    },
                    ticks: {
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace",
                            size: 11
                        },
                        callback: function(value) {
                            return value + '%';
                        }
                    },
                    title: {
                        display: true,
                        text: 'Percentage of Posts (by subreddit)',
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace",
                            size: 12
                        }
                    }
                },
                y: {
                    stacked: false,
                    grid: {
                        color: '#2a662a',
                        borderColor: '#2a662a'
                    },
                    ticks: {
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace",
                            size: 11
                        }
                    }
                }
            }
        }
    });
}

// Function to update the COUNT chart based on dropdown selection
function updateTagChart() {
    if (!tagChartData || !subredditNames) {
        console.log('Tag chart data not available');
        return;
    }
    
    const selected1 = document.getElementById('subredditSelect1').value;
    const selected2 = document.getElementById('subredditSelect2').value;
    
    // Prepare datasets
    let datasets = [];
    
    if (selected1 === 'all' && selected2 === 'other') {
        // Default: all subreddits combined
        datasets = [{
            label: 'All Subreddits',
            data: tagChartData.global_counts,
            backgroundColor: '#00FF00',
            borderColor: '#00FF00',
            borderWidth: 1
        }];
    } else if (selected1 === 'all' || selected2 === 'other') {
        // One specific vs all others
        const specificSub = selected1 === 'all' ? selected2 : selected1;
        const selectedCounts = [];
        const otherCounts = [];
        
        tagChartData.tag_names.forEach((tagName, index) => {
            const globalCount = tagChartData.global_counts[index];
            const subredditCount = tagChartData.breakdown_by_subreddit[tagName][specificSub] || 0;
            const otherCount = globalCount - subredditCount;
            
            selectedCounts.push(subredditCount);
            otherCounts.push(otherCount);
        });
        
        datasets = [
            {
                label: `r/${specificSub}`,
                data: selectedCounts,
                backgroundColor: '#00FF00',
                borderColor: '#00FF00',
                borderWidth: 1
            },
            {
                label: 'All Other Subreddits',
                data: otherCounts,
                backgroundColor: '#2a662a',
                borderColor: '#2a662a',
                borderWidth: 1
            }
        ];
    } else {
        // Two specific subreddits
        const counts1 = [];
        const counts2 = [];
        
        tagChartData.tag_names.forEach((tagName) => {
            const count1 = tagChartData.breakdown_by_subreddit[tagName][selected1] || 0;
            const count2 = tagChartData.breakdown_by_subreddit[tagName][selected2] || 0;
            
            counts1.push(count1);
            counts2.push(count2);
        });
        
        datasets = [
            {
                label: `r/${selected1}`,
                data: counts1,
                backgroundColor: '#00FF00',
                borderColor: '#00FF00',
                borderWidth: 1
            },
            {
                label: `r/${selected2}`,
                data: counts2,
                backgroundColor: '#2a662a',
                borderColor: '#2a662a',
                borderWidth: 1
            }
        ];
    }
    
    // Destroy existing chart if it exists
    if (tagChart) {
        tagChart.destroy();
    }
    
    // Create new chart
    const tagCtx = document.getElementById('tagChart').getContext('2d');
    tagChart = new Chart(tagCtx, {
        type: 'bar',
        data: {
            labels: tagChartData.tag_names,
            datasets: datasets
        },
        options: {
            indexAxis: 'y',  // Horizontal bars
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: datasets.length > 1,
                    labels: {
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace",
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: '#252525',
                    titleColor: '#00FF00',
                    bodyColor: '#00FF00',
                    borderColor: '#2a662a',
                    borderWidth: 1,
                    titleFont: {
                        family: "'Courier New', monospace"
                    },
                    bodyFont: {
                        family: "'Courier New', monospace"
                    },
                    callbacks: {
                        footer: function(tooltipItems) {
                            // Only show total when stacking
                            if (selected1 === 'all' && selected2 === 'other') return '';
                            let total = 0;
                            tooltipItems.forEach(item => {
                                total += item.parsed.x;
                            });
                            return 'Total: ' + total.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                x: {
                    stacked: (selected1 === 'all' || selected2 === 'other') && !(selected1 === 'all' && selected2 === 'other'),
                    grid: {
                        color: '#2a662a',
                        borderColor: '#2a662a'
                    },
                    ticks: {
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace",
                            size: 11
                        }
                    },
                    title: {
                        display: true,
                        text: 'Number of Posts',
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace",
                            size: 12
                        }
                    }
                },
                y: {
                    stacked: (selected1 === 'all' || selected2 === 'other') && !(selected1 === 'all' && selected2 === 'other'),
                    grid: {
                        color: '#2a662a',
                        borderColor: '#2a662a'
                    },
                    ticks: {
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace",
                            size: 11
                        }
                    }
                }
            }
        }
    });
}

// Initialize both charts on page load with "All Subreddits" only if we have data
if (tagChartData && subredditNames) {
    updateAllTagCharts();
}

// === EXPLORE TAB FUNCTIONALITY ===

// Get explore data from Django
const exploreData = {{ explore_data|safe }};

// Color palettes for different dimensions
const regionColors = {
    'Northeast': '#00FF00',
    'Midwest': '#00BFFF',
    'South': '#FF6B6B',
    'West': '#FFD700',
    'Unknown': '#888888'
};

const tierColors = {
    1: '#1a5c1a',
    2: '#2a7d2a',
    3: '#3a9d3a',
    4: '#5abd5a',
    5: '#7add7a'
};

// Axis labels for display
const axisLabels = {
    'population': 'Population',
    'pop_density': 'Population Density (per sq mi)',
    'subscribers': 'Subscribers',
    'posts_7d': 'Posts (Last 7 Days)',
    'comments_7d': 'Comments (Last 7 Days)',
    'upvotes_7d': 'Upvotes (Last 7 Days)',
    'subs_per_10k_pop': 'Subscribers per 10k Population',
    'posts_per_10k_pop': 'Posts per 10k Population',
    'posts_per_1k_subs': 'Posts per 1k Subscribers',
    'comments_per_1k_subs': 'Comments per 1k Subscribers',
    'upvotes_per_1k_subs': 'Upvotes per 1k Subscribers',
    'comments_per_post': 'Comments per Post',
    'upvotes_per_post': 'Upvotes per Post'
};

// Global chart instance
let exploreScatterChart = null;

// Current table sort state
let currentSortColumn = 'subscribers';
let currentSortDirection = 'desc';

function updateExploreChart() {
    const xAxis = document.getElementById('exploreXAxis').value;
    const yAxis = document.getElementById('exploreYAxis').value;
    const colorBy = document.getElementById('exploreColorBy').value;
    
    // Group data by color category
    let datasets = [];
    
    if (colorBy === 'none') {
        // Single dataset, all green
        const points = exploreData
            .filter(d => d[xAxis] !== null && d[yAxis] !== null)
            .map(d => ({
                x: d[xAxis],
                y: d[yAxis],
                name: d.name,
                region: d.region,
                pop_tier: d.pop_tier,
                density_tier: d.density_tier
            }));
        
        datasets = [{
            label: 'All Subreddits',
            data: points,
            backgroundColor: 'rgba(0, 255, 0, 0.5)',
            borderColor: '#00FF00',
            borderWidth: 1,
            pointRadius: 8,
            pointHoverRadius: 10
        }];
    } else if (colorBy === 'region') {
        // Group by region
        const regions = ['Northeast', 'Midwest', 'South', 'West'];
        regions.forEach(region => {
            const points = exploreData
                .filter(d => d.region === region && d[xAxis] !== null && d[yAxis] !== null)
                .map(d => ({
                    x: d[xAxis],
                    y: d[yAxis],
                    name: d.name,
                    region: d.region,
                    pop_tier: d.pop_tier,
                    density_tier: d.density_tier
                }));
            
            if (points.length > 0) {
                datasets.push({
                    label: region,
                    data: points,
                    backgroundColor: regionColors[region] + '80',  // Add alpha
                    borderColor: regionColors[region],
                    borderWidth: 1,
                    pointRadius: 8,
                    pointHoverRadius: 10
                });
            }
        });
    } else {
        // Group by tier (pop_tier or density_tier)
        for (let tier = 1; tier <= 5; tier++) {
            const points = exploreData
                .filter(d => d[colorBy] === tier && d[xAxis] !== null && d[yAxis] !== null)
                .map(d => ({
                    x: d[xAxis],
                    y: d[yAxis],
                    name: d.name,
                    region: d.region,
                    pop_tier: d.pop_tier,
                    density_tier: d.density_tier
                }));
            
            if (points.length > 0) {
                const tierLabel = colorBy === 'pop_tier' ? `Pop Tier ${tier}` : `Density Tier ${tier}`;
                datasets.push({
                    label: tierLabel,
                    data: points,
                    backgroundColor: tierColors[tier] + 'CC',
                    borderColor: tierColors[tier],
                    borderWidth: 1,
                    pointRadius: 8,
                    pointHoverRadius: 10
                });
            }
        }
    }
    
    // Destroy existing chart
    if (exploreScatterChart) {
        exploreScatterChart.destroy();
    }
    
    // Create new chart
    const ctx = document.getElementById('exploreScatterChart').getContext('2d');
    exploreScatterChart = new Chart(ctx, {
        type: 'scatter',
        data: { datasets: datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: colorBy !== 'none',
                    labels: {
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace",
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: '#252525',
                    titleColor: '#00FF00',
                    bodyColor: '#00FF00',
                    borderColor: '#2a662a',
                    borderWidth: 1,
                    titleFont: {
                        family: "'Courier New', monospace"
                    },
                    bodyFont: {
                        family: "'Courier New', monospace"
                    },
                    callbacks: {
                        label: function(context) {
                            const point = context.raw;
                            return [
                                `r/${point.name}`,
                                `${axisLabels[xAxis]}: ${formatValue(point.x)}`,
                                `${axisLabels[yAxis]}: ${formatValue(point.y)}`,
                                `Region: ${point.region}`,
                                `Pop Tier: ${point.pop_tier}, Density Tier: ${point.density_tier}`
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: axisLabels[xAxis],
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace",
                            size: 14
                        }
                    },
                    grid: {
                        color: '#2a662a',
                        borderColor: '#2a662a'
                    },
                    ticks: {
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace"
                        },
                        callback: function(value) {
                            return formatValue(value);
                        }
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: axisLabels[yAxis],
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace",
                            size: 14
                        }
                    },
                    grid: {
                        color: '#2a662a',
                        borderColor: '#2a662a'
                    },
                    ticks: {
                        color: '#00FF00',
                        font: {
                            family: "'Courier New', monospace"
                        },
                        callback: function(value) {
                            return formatValue(value);
                        }
                    }
                }
            }
        }
    });
}

function formatValue(value) {
    if (value === null || value === undefined) return 'N/A';
    if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
    if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
    if (value < 1 && value > 0) return value.toFixed(2);
    return value.toLocaleString();
}

function renderExploreTable() {
    // Sort data
    const sortedData = [...exploreData].sort((a, b) => {
        let aVal = a[currentSortColumn];
        let bVal = b[currentSortColumn];
        
        // Handle nulls
        if (aVal === null) aVal = currentSortDirection === 'asc' ? Infinity : -Infinity;
        if (bVal === null) bVal = currentSortDirection === 'asc' ? Infinity : -Infinity;
        
        // Handle strings
        if (typeof aVal === 'string') {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
        }
        
        if (currentSortDirection === 'asc') {
            return aVal > bVal ? 1 : -1;
        } else {
            return aVal < bVal ? 1 : -1;
        }
    });
    
    // Update header sort indicators
    document.querySelectorAll('.explore-table th').forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
        if (th.dataset.sort === currentSortColumn) {
            th.classList.add(currentSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
    });
    
    // Render table rows
    const tbody = document.getElementById('exploreTableBody');
    tbody.innerHTML = sortedData.map(d => `
        <tr>
            <td><a href="/r/${d.name}/" class="subreddit-link">r/${d.name}</a></td>
            <td>${d.region}</td>
            <td><span class="tier-badge tier-${d.pop_tier}">${d.pop_tier || 'N/A'}</span></td>
            <td>${d.subscribers ? d.subscribers.toLocaleString() : 'N/A'}</td>
            <td>${d.subs_per_10k_pop !== null ? d.subs_per_10k_pop.toFixed(1) : 'N/A'}</td>
            <td>${d.posts_7d.toLocaleString()}</td>
            <td>${d.posts_per_1k_subs !== null ? d.posts_per_1k_subs.toFixed(2) : 'N/A'}</td>
            <td>${d.comments_per_1k_subs !== null ? d.comments_per_1k_subs.toFixed(2) : 'N/A'}</td>
            <td>${d.upvotes_per_1k_subs !== null ? d.upvotes_per_1k_subs.toFixed(2) : 'N/A'}</td>
            <td>${d.comments_per_post !== null ? d.comments_per_post.toFixed(1) : 'N/A'}</td>
        </tr>
    `).join('');
}

// Add click handlers to table headers
document.querySelectorAll('.explore-table th').forEach(th => {
    th.addEventListener('click', function() {
        const column = this.dataset.sort;
        if (column === currentSortColumn) {
            currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortColumn = column;
            currentSortDirection = 'desc';
        }
        renderExploreTable();
    });
});

// Initialize explore tab on page load
if (exploreData && exploreData.length > 0) {
    updateExploreChart();
    renderExploreTable();
}
</script>
{% endblock %}